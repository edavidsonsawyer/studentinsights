<%= render 'navbar_for_admin_educator_permissions' %>

<div style="margin: 20px;">
  <h4 style="color: black; font-size: 24px; border-bottom: 1px solid #333; margin-bottom: 20px; padding-bottom: 10px;">
    <span>Permissions overview</span>
    <%= link_to 'Adjust permissions', admin_root_url, {
      style: 'margin-left: 10px; vertical-align: middle;'
    } %>
  </h4>
  <div class="educators-authorization-view">
    <h2 style="margin-top: 20px;">Sensitive access</h2>
    <div style="padding-top: 10px">
      <table style="text-align: left; max-width: 1000px;">
        <thead>
          <tr>
            <th style="padding: 5px; text-align: left; background: #eee;">Email</th>
            <th style="padding: 5px; text-align: left; background: #eee;">Name</th>
            <th style="padding: 5px; text-align: left; background: #eee;">Can set<br />permissions</th>
            <th style="padding: 5px; text-align: left; background: #eee;">Restricted<br />notes</th>
            <th style="padding: 5px; text-align: left; background: #eee;">Districtwide</th>
            <th style="padding: 5px; text-align: left; background: #eee;">Admin in SIS</th>
            <th style="padding: 5px; text-align: left; background: #eee;">School</th>
          </tr>
        </thead>
        <tbody>
          <% educators = (@can_set_educators + @admin_educators + @districtwide_educators).uniq %>
          <% educators.map do |educator| %>
            <tr>
              <td><%= educator.email %></td>
              <td><%= link_to educator.full_name, "/educators/view/#{educator.id}" %></td>
              <td>
                <% if educator.can_set_districtwide_access %>
                  <b style="background: #1b82ea; color: white; padding: 5px;">true</b>
                <% else %>
                  <span style="padding: 5px; color: #999;">false</span>
                <% end %>
              </td>
              <td>
                <% if educator.can_view_restricted_notes %>
                  <b style="background: #1b82ea; color: white; padding: 5px;">true</b>
                <% else %>
                  <span style="padding: 5px; color: #999;">false</span>
                <% end %>
              </td>
              <td>
                <% if educator.districtwide_access %>
                  <b style="background: #1b82ea; color: white; padding: 5px;">true</b>
                <% else %>
                  <span style="padding: 5px; color: #999;">false</span>
                <% end %>
              </td>
              <td>
                <% if educator.admin %>
                  <b style="background: #1b82ea; color: white; padding: 5px;">true</b>
                <% else %>
                  <span style="padding: 5px; color: #999;">false</span>
                <% end %>
              </td>
              <td><%= educator.school.try(:name) || "N/A" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <h2 style="margin-top: 40px;">Educator homepages</h2>
    <div style="padding-top: 20px">
      <table style="text-align: left; border-collapse: collapse;">
          <thead>
            <tr style="vertical-align: top;">
              <th style="padding: 5px; text-align: left; background: #eee;">Last login<br/>(days ago)</th>
              <th style="padding: 5px; text-align: left; background: #eee;">Logins<br/>(all time)</th>
              <th style="padding: 5px; text-align: left; background: #eee;">Email</th>
              <th style="padding: 5px; text-align: left; background: #eee;">Name</th>
              <th style="padding: 5px; text-align: left; background: #eee;">School</th>
              <th style="padding: 5px; text-align: left; background: #eee;">Links</th>
              <th style="padding: 5px; text-align: left; background: #eee;">Masquerade</th>
            </tr>
          </thead>
          <tbody>
            <%
              @navbar_links_map = {}
              sorted_educators = @all_educators.sort_by do |educator|
                navbar_links = PathsForEducator.new(educator).navbar_links
                @navbar_links_map[educator.id] = navbar_links
                navbar_links.keys
              end
            %>
            <% sorted_educators.map do |educator| %>
              <%
                days_since_last_sign_in = if educator.last_sign_in_at.nil?
                  0
                else
                  ((Time.now - educator.last_sign_in_at) / 1.day).round
                end
                color = if days_since_last_sign_in == 0
                  'white'
                elsif days_since_last_sign_in < 7
                  '#006d2c'
                elsif days_since_last_sign_in < 30
                  '#31a354'
                elsif days_since_last_sign_in < 90
                  '#a1d99b'
                elsif days_since_last_sign_in < 365
                  '#c7e9c0'
                else
                  '#f7fcf5'
                end
              %>
              <tr style="vertical-align: top;">
                <td style="padding: 5px;">
                  <span style="display: inline-block; width: 2em; text-align: right; color: white; padding: 5px; background: <%= color %>;">
                    <%= days_since_last_sign_in %>
                  </span>
                </td>
                <td style="padding: 5px;"><%= educator.sign_in_count %></td>
                <td style="padding: 5px;"><%= educator.email %></td>
                <td style="padding: 5px;"><%= link_to educator.full_name, "/educators/view/#{educator.id}" %></td>
                <td style="padding: 5px;"><%= educator.school.try(:name) %></td>
                <td>
                  <% @navbar_links_map[educator.id].map do |path, key| %>
                    <%= link_to path, key %>
                  <% end %>
                </td>
                <td>
                  <% if current_educator(super: true) != educator && current_educator != educator %>
                    <%= link_to 'become', admin_masquerade_become_path(masquerading_educator_id: educator.id), { method: :post, class: 'become-link' } %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
    </div>
  </div>
</div>